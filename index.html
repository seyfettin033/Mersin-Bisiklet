<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cami Bulucu Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --ana-renk: #e30a17; --altin: #d4af37; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; background: #f8f8f8; }

        /* Header Tasarƒ±mƒ± */
        header { background: var(--ana-renk); color: white; padding: 12px; text-align: center; border-bottom: 3px solid #b10812; z-index: 1000; }
        .search-container { background: white; margin: 8px; border-radius: 20px; display: flex; padding: 5px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-container input { border: none; outline: none; flex: 1; font-size: 16px; padding: 5px; }

        /* Harita ve Buton */
        #map-wrapper { position: relative; flex: 1; min-height: 300px; }
        #map { height: 100%; width: 100%; }
        
        #scan-btn {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: var(--ana-renk); color: white; border: 2px solid white;
            padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px;
            display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
        }

        /* Liste Alanƒ± */
        #panel { background: white; height: 38vh; overflow-y: auto; border-top: 4px solid var(--altin); }
        .status-bar { padding: 10px; background: #333; color: white; font-size: 11px; display: flex; justify-content: space-around; }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .btn-group { display: flex; gap: 8px; }
        .action-btn { flex: 1; text-align: center; text-decoration: none; padding: 10px; border-radius: 6px; font-size: 12px; font-weight: bold; color: white; border: none; }
        
        .bg-blue { background: #007bff; }
        .bg-green { background: #28a745; }
        .bg-red { background: #dc3545; }

        .red-dot { background: red; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header>
    <h2>üïå CAMƒ∞ BULUCU PRO</h2>
</header>

<div class="search-container">
    <input type="text" id="cityInput" placeholder="ƒ∞l veya ƒ∞l√ße yazƒ±n..." onkeypress="if(event.key==='Enter') searchLocation()">
    <button onclick="searchLocation()" style="background:none; border:none; color:var(--ana-renk); font-weight:bold;">ARA</button>
</div>

<div id="map-wrapper">
    <button id="scan-btn" onclick="manualScan()">üìç BU B√ñLGEYƒ∞ TARA</button>
    <div id="map"></div>
</div>

<div id="panel">
    <div id="prayerTimes" class="status-bar">Vakitler y√ºkleniyor...</div>
    <div style="padding: 10px; font-weight: bold; font-size: 14px; border-bottom: 1px solid #eee;">
        Bulunan Noktalar: <span id="count">0</span>
    </div>
    <div id="results"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map', { zoomControl: false }).setView([39.9, 32.8], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markerLayer = L.layerGroup().addTo(map);

    // Ba≈ülangƒ±√ßta konumu al
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(p) {
            var lat = p.coords.latitude, lon = p.coords.longitude;
            map.setView([lat, lon], 15);
            fetchData(lat, lon);
            updatePrayerTimes(lat, lon);
        });
    }

    function searchLocation() {
        var val = document.getElementById('cityInput').value;
        if(!val) return;
        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(val + " Turkey"))
        .then(r => r.json()).then(d => {
            if(d.length > 0) {
                map.setView([d[0].lat, d[0].lon], 14);
                manualScan();
            } else { alert("Yer bulunamadƒ±!"); }
        });
    }

    function manualScan() {
        var c = map.getCenter();
        document.getElementById('scan-btn').style.display = "none";
        fetchData(c.lat, c.lng);
        updatePrayerTimes(c.lat, c.lng);
    }

    function updatePrayerTimes(lat, lon) {
        fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=13`)
        .then(r => r.json()).then(d => {
            var t = d.data.timings;
            document.getElementById('prayerTimes').innerHTML = `<span>ƒ∞msak ${t.Fajr}</span> <span>√ñƒüle ${t.Dhuhr}</span> <span>ƒ∞kindi ${t.Asr}</span> <span>Ak≈üam ${t.Maghrib}</span> <span>Yatsƒ± ${t.Isha}</span>`;
        });
    }

    function fetchData(lat, lon) {
        document.getElementById('results').innerHTML = "<p style='padding:20px'>Veriler √ßekiliyor, l√ºtfen bekleyin...</p>";
        // Query: 2.5km yarƒ±√ßap
        var query = `[out:json][timeout:25];(node["amenity"="place_of_worship"]["religion"="muslim"](around:2500,${lat},${lon});way["amenity"="place_of_worship"]["religion"="muslim"](around:2500,${lat},${lon}););out center;`;
        
        fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: "data=" + encodeURIComponent(query) })
        .then(r => {
            if(!r.ok) throw new Error();
            return r.json();
        })
        .then(data => {
            markerLayer.clearLayers();
            var h = "";
            var count = 0;
            data.elements.forEach(el => {
                count++;
                var la = el.lat || el.center.lat;
                var lo = el.lon || el.center.lng;
                var name = el.tags.name || "ƒ∞simsiz Cami / Mescit";
                var osmUrl = `https://www.openstreetmap.org/edit?${el.type}=${el.id}`;

                if (el.tags.name) {
                    L.marker([la, lo]).addTo(markerLayer).bindPopup(name);
                    h += `<div class="list-item"><b>${name}</b><div class="btn-group"><a href="https://www.google.com/maps/dir/?api=1&destination=${la},${lo}" target="_blank" class="action-btn bg-blue">YOL TARƒ∞Fƒ∞</a></div></div>`;
                } else {
                    L.marker([la, lo], {icon: L.divIcon({className:'red-dot', iconSize:[12,12]})}).addTo(markerLayer);
                    h += `<div class="list-item" style="background:#fff5f5"><b style="color:red">Eksik ƒ∞sim!</b><div class="btn-group"><button onclick="map.setView([${la},${lo}], 18)" class="action-btn bg-red">HARƒ∞TADA BUL</button><a href="${osmUrl}" target="_blank" class="action-btn bg-green">OSM'DE D√úZENLE</a></div></div>`;
                }
            });
            document.getElementById('results').innerHTML = h || "<p style='padding:20px'>Bu b√∂lgede cami bulunamadƒ±.</p>";
            document.getElementById('count').innerText = count;
        })
        .catch(() => {
            document.getElementById('results').innerHTML = "<p style='padding:20px; color:red;'>Hata olu≈ütu! L√ºtfen 'Bu B√∂lgeyi Tara' butonuna tekrar basƒ±n.</p>";
        });
    }

    map.on('moveend', function() {
        document.getElementById('scan-btn').style.display = "block";
    });
</script>
</body>
</html>
