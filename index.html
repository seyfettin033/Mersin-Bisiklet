<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YakÄ±nÄ±mdaki Camiler</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Font Awesome -->
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f4f4;
}
#map {
  height: 55vh;
}
.panel {
  padding: 10px;
  background: #fff;
}
input, button {
  width: 100%;
  padding: 8px;
  margin-bottom: 6px;
}
button {
  background: #2c7be5;
  color: #fff;
  border: none;
  border-radius: 4px;
}
button.secondary {
  background: #28a745;
}
button.pdf {
  background: #dc3545;
}
#durum {
  font-size: 14px;
  margin-bottom: 5px;
}
#sayac {
  font-weight: bold;
  margin-bottom: 6px;
}
.cami {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
}
.cami a {
  font-size: 12px;
  color: #2c7be5;
  text-decoration: none;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">

<input id="adres"
 placeholder="Ä°l / Ä°lÃ§e gir (Ã¶rn: Mersin Akdeniz)">

<button onclick="adresleAra()">
ğŸ“ Ä°l / Ä°lÃ§e ile Ara
</button>

<button onclick="konumlaAra()" class="secondary">
ğŸ“¡ Konumuma GÃ¶re Ara
</button>

<hr>

<div id="durum">HazÄ±r</div>
<div id="sayac">0 Cami</div>
<div id="liste"></div>

<hr>

<button onclick="excelIndir()" class="secondary">
ğŸ“¥ Excel (CSV) Ä°ndir
</button>

<button onclick="pdfIndir()" class="pdf">
ğŸ“„ PDF Ä°ndir
</button>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let layer = L.layerGroup();
let camiVerileri = [];

map = L.map('map').setView([36.8121, 34.6415], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

layer.addTo(map);

// ---------------- KONUM ----------------
function konumlaAra() {
  if (!navigator.geolocation) {
    alert("Konum desteklenmiyor");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    p => {
      map.setView([p.coords.latitude, p.coords.longitude], 14);
      camileriGetir(p.coords.latitude, p.coords.longitude);
    },
    () => alert("Konum izni verilmedi")
  );
}

// ---------------- ADRES ----------------
function adresleAra() {
  const adres = document.getElementById("adres").value;
  if (!adres) return alert("Adres gir");

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${adres}`)
    .then(r => r.json())
    .then(d => {
      if (!d.length) return alert("Adres bulunamadÄ±");
      map.setView([d[0].lat, d[0].lon], 13);
      camileriGetir(d[0].lat, d[0].lon);
    });
}

// ---------------- CAMÄ°LER ----------------
function camileriGetir(lat, lon) {
  document.getElementById("durum").innerHTML =
    '<i class="fa fa-spinner fa-spin"></i> Camiler yÃ¼kleniyor...';

  const sorgu = `
  [out:json][timeout:25];
  (
    node["amenity"="place_of_worship"](around:3000,${lat},${lon});
    way["amenity"="place_of_worship"](around:3000,${lat},${lon});
  );
  out center;
  `;

  fetch("https://overpass.kumi.systems/api/interpreter", {
    method: "POST",
    body: "data=" + encodeURIComponent(sorgu)
  })
  .then(r => r.json())
  .then(d => {
    layer.clearLayers();
    camiVerileri = [];
    document.getElementById("liste").innerHTML = "";

    if (!d.elements || !d.elements.length) {
      document.getElementById("durum").innerText =
        "Cami bulunamadÄ±";
      document.getElementById("sayac").innerText = "0 Cami";
      return;
    }

    d.elements.forEach(e => {
      const la = e.lat || e.center?.lat;
      const lo = e.lon || e.center?.lng;
      if (!la || !lo) return;

      const ad = e.tags?.name || "Ä°simsiz Cami";

      camiVerileri.push({ ad, la, lo });

      L.marker([la, lo]).addTo(layer)
        .bindPopup(`
          <strong>${ad}</strong><br>
          <a target="_blank"
          href="https://www.google.com/maps/dir/?api=1&destination=${la},${lo}">
          ğŸ“ Yol Tarifi
          </a>
        `);

      document.getElementById("liste").innerHTML += `
        <div class="cami">
          <span>${ad}</span>
          <a target="_blank"
           href="https://www.google.com/maps/dir/?api=1&destination=${la},${lo}">
           Yol Tarifi
          </a>
        </div>
      `;
    });

    document.getElementById("sayac").innerText =
      camiVerileri.length + " Cami";
    document.getElementById("durum").innerText = "GÃ¼ncel";
  })
  .catch(() => {
    document.getElementById("durum").innerText =
      "Sunucuya eriÅŸilemedi";
  });
}

// ---------------- EXCEL ----------------
function excelIndir() {
  if (!camiVerileri.length) return alert("Veri yok");

  let csv = "Cami AdÄ±,Enlem,Boylam\n";
  camiVerileri.forEach(c =>
    csv += `"${c.ad}",${c.la},${c.lo}\n`
  );

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "camiler.csv";
  a.click();
}

// ---------------- PDF ----------------
function pdfIndir() {
  if (!camiVerileri.length) return alert("Veri yok");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;

  pdf.text("Cami Listesi", 10, y);
  y += 10;

  camiVerileri.forEach(c => {
    pdf.text("- " + c.ad, 10, y);
    y += 7;
  });

  pdf.save("camiler.pdf");
}
</script>

</body>
</html>