<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cami Rehberi Mobil</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        :root { --ana: #c0392b; --arka: #f8f9fa; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #map { flex: 1; width: 100%; z-index: 1; }

        /* Mobil Alt Panel (Bottom Sheet) */
        #bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 1000;
            max-height: 85vh; min-height: 120px; display: flex; flex-direction: column;
            transition: transform 0.3s ease;
        }

        .handle { width: 40px; height: 5px; background: #ccc; border-radius: 10px; margin: 10px auto; cursor: pointer; }

        .sheet-header { padding: 0 20px 10px; text-align: center; }
        .sheet-header h2 { margin: 0; font-size: 18px; color: var(--ana); }

        .btn-loc { 
            background: var(--ana); color: white; border: none; padding: 12px; 
            border-radius: 10px; font-weight: bold; width: 90%; margin: 5px auto 15px; 
            display: block; font-size: 14px;
        }

        #list-container { flex: 1; overflow-y: auto; padding: 0 15px 20px; }

        .cami-card { 
            background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .cami-info h4 { margin: 0; font-size: 15px; color: #333; }
        .cami-info span { font-size: 13px; color: var(--ana); font-weight: bold; }
        
        .nav-icon { background: #eee; padding: 10px; border-radius: 50%; text-decoration: none; font-size: 18px; }

        /* Y√ºkleme Ekranƒ± */
        #loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="loader">üîÑ Camiler Aranƒ±yor...</div>
<div id="map"></div>

<div id="bottom-sheet">
    <div class="handle" onclick="toggleSheet()"></div>
    <div class="sheet-header">
        <h2>üïå Yakƒ±ndaki Camiler</h2>
    </div>
    
    <button class="btn-loc" onclick="startLocation()">üìç En Yakƒ±nlarƒ± Listele</button>

    <div id="list-container">
        <p style="text-align:center; color:#999; font-size:14px;">Konum butonuna basarak size en yakƒ±n camileri g√∂rebilirsiniz.</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map = L.map('map', { zoomControl: false }).setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markers = L.markerClusterGroup();
    map.addLayer(markers);

    var userCoords = null;
    var sheetExpanded = false;

    function toggleSheet() {
        const sheet = document.getElementById('bottom-sheet');
        sheetExpanded = !sheetExpanded;
        sheet.style.transform = sheetExpanded ? 'translateY(0)' : 'translateY(calc(85vh - 120px))';
    }

    function startLocation() {
        if (navigator.geolocation) {
            document.getElementById('loader').style.display = 'block';
            navigator.geolocation.getCurrentPosition(pos => {
                userCoords = [pos.coords.latitude, pos.coords.longitude];
                map.setView(userCoords, 15);
                L.circleMarker(userCoords, {radius: 6, color: '#2ecc71', fillOpacity: 1}).addTo(map);
                loadData();
            }, () => {
                alert("L√ºtfen konum izni verin.");
                document.getElementById('loader').style.display = 'none';
            });
        }
    }

    async function loadData() {
        const b = map.getBounds();
        const query = `[out:json][timeout:25];(node["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});way["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out center;`;

        try {
            const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
            const data = await res.json();
            
            let camiler = data.elements.map(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                return {
                    name: el.tags.name || "ƒ∞simsiz Cami",
                    lat: lat, lng: lon,
                    dist: getDistance(userCoords[0], userCoords[1], lat, lon)
                };
            }).sort((a, b) => a.dist - b.dist);

            render(camiler);
        } catch (e) {
            alert("Veri √ßekilemedi.");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function render(list) {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        markers.clearLayers();

        list.forEach(c => {
            const m = L.marker([c.lat, c.lng]);
            m.bindPopup(`<b>${c.name}</b><br><a href="https://www.google.com/maps?q=${c.lat},${c.lng}" target="_blank">Yol Tarifi</a>`);
            markers.addLayer(m);

            const card = document.createElement('div');
            card.className = 'cami-card';
            card.innerHTML = `
                <div class="cami-info">
                    <h4>${c.name}</h4>
                    <span>${c.dist.toFixed(2)} km</span>
                </div>
                <a href="https://www.google.com/maps?q=${c.lat},${c.lng}" class="nav-icon" target="_blank">üöó</a>
            `;
            card.onclick = () => { map.flyTo([c.lat, c.lng], 17); toggleSheet(); };
            container.appendChild(card);
        });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
</script>

</body>
</html>
