<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cami Rehberi Hızlı</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        
        /* Stabil Header */
        header { background: #e30a17; color: white; padding: 10px; z-index: 1000; display: flex; align-items: center; height: 50px; }
        .search { flex: 1; margin-left: 10px; background: white; border-radius: 15px; padding: 5px 10px; display: flex; }
        .search input { border: none; width: 100%; outline: none; font-size: 16px; }

        /* Akıcı Harita */
        #map-box { position: relative; flex: 1; width: 100%; touch-action: none; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }

        /* Buton - Dokunmatik Dostu */
        #tara-btn {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 999; background: #e30a17; color: white; border: 2px solid #fff;
            padding: 12px 24px; border-radius: 30px; font-weight: bold;
            display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Liste Alanı */
        #list-box { height: 35vh; overflow-y: auto; padding: 10px; border-top: 3px solid #d4af37; -webkit-overflow-scrolling: touch; }
        .item { padding: 15px; border-bottom: 1px solid #eee; }
        .btn-row { display: flex; gap: 10px; margin-top: 8px; }
        .btn { flex: 1; padding: 12px; text-align: center; border-radius: 6px; color: white; text-decoration: none; font-size: 13px; font-weight: bold; border: none; }
        
        .blue { background: #007bff; }
        .green { background: #28a745; }
        .red { background: #dc3545; }

        .dot { background: red; border: 2px solid white; border-radius: 50%; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; border: 1px solid white; padding: 2px 5px;">TR</div>
    <div class="search">
        <input type="text" id="city" placeholder="Şehir/İlçe Ara..." onkeypress="if(event.key==='Enter') search()">
    </div>
</header>

<div id="map-box">
    <button id="tara-btn" onclick="scan()">BU BÖLGEYİ TARA</button>
    <div id="map"></div>
</div>

<div id="list-box">
    <div id="info" style="font-size:13px; color:#666; margin-bottom:10px;">Lütfen bekleyin...</div>
    <div id="res"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map, markers;

    // Haritayı Başlat
    function init() {
        try {
            map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([39.9, 32.8], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(p) {
                    var lat = p.coords.latitude, lon = p.coords.longitude;
                    map.setView([lat, lon], 15);
                    load(lat, lon);
                }, function() { document.getElementById('info').innerText = "Konum izni yok."; });
            }

            map.on('moveend', function() { document.getElementById('tara-btn').style.display = "block"; });
        } catch(e) { console.error(e); }
    }

    function search() {
        var val = document.getElementById('city').value;
        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(val))
        .then(function(r){return r.json()}).then(function(d){
            if(d[0]){ map.setView([d[0].lat, d[0].lon], 14); scan(); }
        });
    }

    function scan() {
        var c = map.getCenter();
        document.getElementById('tara-btn').style.display = "none";
        load(c.lat, c.lng);
    }

    function load(lat, lon) {
        document.getElementById('info').innerText = "Yükleniyor...";
        var q = '[out:json][timeout:20];(node["amenity"="place_of_worship"]["religion"="muslim"](around:2500,'+lat+','+lon+');way["amenity"="place_of_worship"]["religion"="muslim"](around:2500,'+lat+','+lon+'););out center;';
        
        fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: "data=" + encodeURIComponent(q) })
        .then(function(r){return r.json()}).then(function(data) {
            markers.clearLayers();
            var h = "";
            data.elements.forEach(function(el) {
                var la = el.lat || el.center.lat, lo = el.lon || el.center.lng;
                var n = el.tags.name, osm = "https://www.openstreetmap.org/edit?" + el.type + "=" + el.id;

                if (n) {
                    L.marker([la, lo]).addTo(markers).bindPopup(n);
                    h += '<div class="item"><b>'+n+'</b><div class="btn-row"><a href="https://www.google.com/maps/dir/?api=1&destination='+la+','+lo+'" target="_blank" class="btn blue">GİT</a></div></div>';
                } else {
                    L.marker([la, lo], {icon: L.divIcon({className:'dot', iconSize:[10,10]})}).addTo(markers);
                    h += '<div class="item" style="background:#fffafa"><b style="color:red">İsimsiz Cami</b><div class="btn-row"><button onclick="map.setView(['+la+','+lo+'], 18)" class="btn red">BUL</button><a href="'+osm+'" target="_blank" class="btn green">OSM DÜZENLE</a></div></div>';
                }
            });
            document.getElementById('res').innerHTML = h || "Sonuç bulunamadı.";
            document.getElementById('info').innerText = data.elements.length + " nokta bulundu.";
        }).catch(function(){ document.getElementById('info').innerText = "Bağlantı hatası."; });
    }

    window.onload = init;
</script>
</body>
</html>
