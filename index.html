<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TÃ¼rkiye Camileri Envanteri | Konum Destekli</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        :root { --main-color: #c0392b; --accent-color: #27ae60; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        #sidebar { 
            width: 360px; background: #fff; border-right: 4px solid var(--main-color); 
            padding: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 12px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }

        #map { flex-grow: 1; z-index: 1; }

        /* Konum Butonu - Yeni */
        .btn-location { 
            background: var(--accent-color); color: white; border: none; padding: 15px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-location:hover { background: #219150; transform: translateY(-2px); }

        .btn-scan { 
            background: var(--main-color); color: white; border: none; padding: 15px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        
        select, input { padding: 12px; border-radius: 8px; border: 2px solid #ddd; outline: none; width: 100%; box-sizing: border-box; }
        
        .status-panel { margin-top: auto; background: #f8f9fa; padding: 15px; border-radius: 10px; font-size: 13px; border-left: 5px solid var(--main-color); }
        .nav-link { display: block; background: #2c3e50; color: white; text-align: center; padding: 8px; border-radius: 5px; text-decoration: none; margin-top: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="text-align:center;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg" width="50">
        <h1 style="font-size:18px; margin:10px 0;">DÄ°JÄ°TAL CAMÄ° REHBERÄ°</h1>
    </div>

    <button class="btn-location" onclick="getLocation()">
        ğŸ“ KONUMUMDAN BAÅLA
    </button>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

    <div>
        <label style="font-size:11px; font-weight:bold; color:#7f8c8d;">Ä°L SEÃ‡Ä°MÄ°</label>
        <select id="ilSelect" onchange="loadDistricts()"></select>
    </div>

    <div>
        <label style="font-size:11px; font-weight:bold; color:#7f8c8d;">Ä°LÃ‡E SEÃ‡Ä°MÄ°</label>
        <select id="ilceSelect" onchange="goToRegion()"></select>
    </div>

    <button class="btn-scan" onclick="fetchOSMData()">ğŸ“¡ BÃ–LGEYÄ° TARA VE LÄ°STELE</button>

    <div class="status-panel">
        <strong>Durum:</strong> <span id="status">HazÄ±r</span><br>
        <strong>GÃ¶rÃ¼nen Eser:</strong> <span id="count">0</span>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // 1. HARÄ°TA AYARLARI
    var map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markers = L.markerClusterGroup();
    map.addLayer(markers);
    var cache = new Set();

    // 2. KONUM FONKSÄ°YONU
    function getLocation() {
        document.getElementById('status').innerText = "Konumunuz alÄ±nÄ±yor...";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setView([lat, lng], 14);
                L.marker([lat, lng], {icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/1673/1673221.png',
                    iconSize: [35, 35]
                })}).addTo(map).bindPopup("<b>BuradasÄ±nÄ±z</b>").openPopup();
                
                document.getElementById('status').innerText = "Konum bulundu, taranÄ±yor...";
                fetchOSMData(); // Konum bulununca otomatik tarama baÅŸlat
            }, () => {
                alert("Konum izni reddedildi veya alÄ±namadÄ±.");
                document.getElementById('status').innerText = "Konum hatasÄ±.";
            });
        }
    }

    // 3. Ä°L/Ä°LÃ‡E VERÄ°TABANI (BasitleÅŸtirilmiÅŸ tam liste)
    const iller = ["Adana", "AdÄ±yaman", "Afyonkarahisar", "AÄŸrÄ±", "Amasya", "Ankara", "Antalya", "Artvin", "AydÄ±n", "BalÄ±kesir", "Bilecik", "BingÃ¶l", "Bitlis", "Bolu", "Burdur", "Bursa", "Ã‡anakkale", "Ã‡ankÄ±rÄ±", "Ã‡orum", "Denizli", "DiyarbakÄ±r", "Edirne", "ElazÄ±ÄŸ", "Erzincan", "Erzurum", "EskiÅŸehir", "Gaziantep", "Giresun", "GÃ¼mÃ¼ÅŸhane", "Hakkari", "Hatay", "Isparta", "Ä°Ã§el (Mersin)", "Ä°stanbul", "Ä°zmir", "Kars", "Kastamonu", "Kayseri", "KÄ±rklareli", "KÄ±rÅŸehir", "Kocaeli", "Konya", "KÃ¼tahya", "Malatya", "Manisa", "KahramanmaraÅŸ", "Mardin", "MuÄŸla", "MuÅŸ", "NevÅŸehir", "NiÄŸde", "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", "TekirdaÄŸ", "Tokat", "Trabzon", "Tunceli", "ÅanlÄ±urfa", "UÅŸak", "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", "KÄ±rÄ±kkale", "Batman", "ÅÄ±rnak", "BartÄ±n", "Ardahan", "IÄŸdÄ±r", "Yalova", "KarabÃ¼k", "Kilis", "Osmaniye", "DÃ¼zce"];
    
    const ilDropdown = document.getElementById('ilSelect');
    iller.sort().forEach(il => {
        let opt = document.createElement('option');
        opt.value = il; opt.text = il;
        ilDropdown.add(opt);
    });

    async function goToRegion() {
        const query = document.getElementById('ilceSelect').value + " " + document.getElementById('ilSelect').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`);
        const data = await res.json();
        if(data[0]) map.setView([data[0].lat, data[0].lon], 13);
    }

    // 4. CANLI OSM VERÄ° MOTORU
    async function fetchOSMData() {
        document.getElementById('status').innerText = "OSM VeritabanÄ± taranÄ±yor...";
        const b = map.getBounds();
        const overpassQuery = `[out:json][timeout:30];(node["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});way["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out center;`;
        
        try {
            const response = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery));
            const result = await response.json();
            
            result.elements.forEach(el => {
                if(!cache.has(el.id)) {
                    const lat = el.lat || el.center.lat;
                    const lon = el.lon || el.center.lon;
                    const name = el.tags.name || "Ä°simsiz Cami";
                    
                    const m = L.marker([lat, lon]);
                    m.bindPopup(`<b>${name}</b><br><small>KayÄ±tlÄ± OSM Verisi</small><br><a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="nav-link">ğŸ“ Navigasyonu BaÅŸlat</a>`);
                    markers.addLayer(m);
                    cache.add(el.id);
                }
            });
            document.getElementById('status').innerText = "BÃ¶lge yÃ¼klendi.";
            document.getElementById('count').innerText = cache.size;
        } catch (e) {
            document.getElementById('status').innerText = "Hata oluÅŸtu.";
        }
    }
</script>

</body>
</html>
