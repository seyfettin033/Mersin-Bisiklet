<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ¼slÃ¼man Camileri PortalÄ± | Stabil & SÄ±ralÄ±</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        :root { --main: #c0392b; --success: #27ae60; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; background: #f4f4f4; }
        
        #sidebar { 
            width: 380px; background: white; border-right: 4px solid var(--main); 
            padding: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }

        #map { flex-grow: 1; z-index: 1; }

        .btn-loc { 
            background: var(--success); color: white; border: none; padding: 15px; 
            border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); transition: 0.3s;
        }
        .btn-loc:hover { transform: translateY(-2px); background: #219150; }

        #list-container { 
            flex-grow: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px;
        }

        .cami-item { 
            background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 8px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent;
        }
        .cami-item:hover { border-left-color: var(--main); background: #fdf2f2; }
        .cami-item h4 { margin: 0 0 5px 0; font-size: 14px; color: #333; }
        .cami-item span { font-size: 12px; color: var(--main); font-weight: bold; }

        .loader { display: none; text-align: center; color: var(--main); font-weight: bold; padding: 10px; font-size: 13px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="text-align:center;">
        <h2 style="margin:0; color:var(--main);">MÃœSLÃœMAN <br>CAMÄ°LERÄ°</h2>
        <p style="font-size:11px; color:#666;">En yakÄ±n camiler mesafeye gÃ¶re sÄ±ralanÄ±r.</p>
    </div>

    <button class="btn-loc" onclick="startLocation()">ğŸ“ KONUMUMU BUL VE SIRALA</button>

    <div id="loader" class="loader">ğŸ”„ Veriler SÄ±ralanÄ±yor...</div>

    <div id="list-container">
        <p id="info" style="font-size:13px; color:#999; text-align:center;">Konumunuzu paylaÅŸtÄ±ÄŸÄ±nÄ±zda en yakÄ±n camiler burada listelenecek.</p>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markers = L.markerClusterGroup();
    map.addLayer(markers);

    var userCoords = null;
    var allCamiler = [];

    // 1. KONUMU BAÅLAT
    function startLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userCoords = [pos.coords.latitude, pos.coords.longitude];
                map.setView(userCoords, 14);
                
                // Konum Ä°ÅŸareti
                L.circleMarker(userCoords, {radius: 8, color: '#27ae60', fillOpacity: 1}).addTo(map).bindPopup("Siz buradasÄ±nÄ±z");
                
                loadData();
            }, () => alert("Konum izni verilmedi."));
        }
    }

    // 2. VERÄ°LERÄ° Ã‡EK VE SIRALA
    async function loadData() {
        const loader = document.getElementById('loader');
        const listContainer = document.getElementById('list-container');
        loader.style.display = 'block';

        const b = map.getBounds();
        const query = `[out:json][timeout:25];(node["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});way["amenity"="place_of_worship"]["religion"="muslim"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out center;`;

        try {
            const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
            const data = await res.json();
            
            allCamiler = data.elements.map(el => {
                const lat = el.lat || el.center.lat;
                const lon = el.lon || el.center.lon;
                return {
                    id: el.id,
                    name: el.tags.name || "Ä°simsiz Cami",
                    lat: lat,
                    lng: lon,
                    dist: userCoords ? getDistance(userCoords[0], userCoords[1], lat, lon) : 0
                };
            });

            // MESAFEYE GÃ–RE SIRALA (En YakÄ±n En Ãœstte)
            if(userCoords) allCamiler.sort((a, b) => a.dist - b.dist);

            renderUI();
        } catch (e) {
            console.error(e);
        } finally {
            loader.style.display = 'none';
        }
    }

    // 3. ARAYÃœZÃœ Ã‡Ä°Z
    function renderUI() {
        const listContainer = document.getElementById('list-container');
        listContainer.innerHTML = '';
        markers.clearLayers();

        allCamiler.forEach(cami => {
            // Harita Markeri
            const m = L.marker([cami.lat, cami.lng]);
            m.bindPopup(`<b>${cami.name}</b><br>Mesafe: ${cami.dist.toFixed(2)} km`);
            markers.addLayer(m);

            // Liste Ã–ÄŸesi
            const div = document.createElement('div');
            div.className = 'cami-item';
            div.innerHTML = `
                <h4>${cami.name}</h4>
                <span>ğŸ“ ${cami.dist.toFixed(2)} km uzaklÄ±kta</span>
            `;
            div.onclick = () => map.flyTo([cami.lat, cami.lng], 16);
            listContainer.appendChild(div);
        });
    }

    // Haversine Mesafesi Hesaplama
    function getDistance(lat1, lon1, lat2, lon2) {
        var R = 6371; // DÃ¼nya yarÄ±Ã§apÄ± km
        var dLat = deg2rad(lat2-lat1);
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // Harita hareket ettiÄŸinde yeni bÃ¶lgeyi yÃ¼kle
    map.on('moveend', () => { if(userCoords) loadData(); });
</script>

</body>
</html>
